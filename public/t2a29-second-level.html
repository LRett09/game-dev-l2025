<body id="myBody" style="background-repeat:repeat; background-size:25%;" background="Boss Background.gif">

<img id="myImg01" style="position:absolute; width:100px; height:80px; top:800px; left:50px" src="img01.gif">
<img id="myImg02" style="position:absolute; width:280px; height:200px; top:400px; left:950px" src="BossOne.gif">
<img id="attackBox" style="position:absolute; width:80px; height:120px; top:400px; left:950px" src="BaseballBat.png">

<img id="myAtk01" style="position:absolute; width:80px; height:80px; top:400px; left:950px" src="BossAttack01.png">
<img id="myAtk03" style="position:absolute; width:80px; height:80px; top:400px; left:950px" src="BossAttack03.gif">

<script>

//Global Variables
  let moveAmount = 10
  let x = 50
  let y = 800

  let isAttacking = false
  let attackDuration = 200
  let myDirection = "right"
  
  let playerHP = 3
  let iFrameTime = 0
  let lastHitTime = 0
  const IFRAME_DURATION = 1000 

  let myImg01
  let myImg02
  let attackBox

  let bossFight = true
  let myEnemyHp = 0
  let currentAttack = 0
  let atkActive = true
  let atkSpawned = false

  let myAtk01
  let myAtk03
  let atk03CanHit
  let atkStartTime = 0


  window.onload = function () {

	myImg01 = document.getElementById("myImg01")
    myImg02 = document.getElementById("myImg02")
    myAtk01 = document.getElementById("myAtk01")
	myAtk03 = document.getElementById("myAtk03")
	myAtk03.style.display = "none"

   attackBox = document.getElementById("attackBox")
   attackBox.style.display = "none"


    setInterval(BossAttack, 20)
	  
	  //Movement
	  	document.addEventListener("keydown", function(e) {

		 let oldX = x
  		 let oldY = y
			
        if (e.key === "w") y -= moveAmount
        if (e.key === "s") y += moveAmount
        if (e.key === "a") {x -= moveAmount; myDirection = "left"}
        if (e.key === "d") {x += moveAmount; myDirection = "right"}
		
		if (e.key === " ") {
        attack()
		myHitOther()
		}

        myImg01.style.left = x + "px"
        myImg01.style.top  = y + "px"

		if (myHitOther('myImg01','myImg02')) {
        x = oldX
        y = oldY
        myImg01.style.left = x + "px"
        myImg01.style.top  = y + "px"
    }
})

// Collision
  function myHitOther(my1,my2){
    let a = document.getElementById(my1)
    let b = document.getElementById(my2)

    let left1 = parseInt(a.style.left)
    let right1 = left1 + parseInt(a.style.width)
    let top1 = parseInt(a.style.top)
    let bottom1 = top1 + parseInt(a.style.height)

    let left2 = parseInt(b.style.left)
    let right2 = left2 + parseInt(b.style.width)
    let top2 = parseInt(b.style.top)
    let bottom2 = top2 + parseInt(b.style.height)

    return right1 >= left2 && left1 <= right2 &&
           bottom1 >= top2 && top1 <= bottom2
}

//The bosses attacks
function BossAttack() {
  if (!bossFight) return

  // Spawn once
// Spawn phase
if (!atkSpawned) {
  currentAttack = Math.random() < 0.5 ? 1 : 3
  atkSpawned = true
  atkStartTime = Date.now()

  if (currentAttack === 1) {
    myAtk01.style.display = "block"
    myAtk01.style.left = "950px"
    myAtk01.style.top = "400px"
  }

  if (currentAttack === 3) {
    myAtk03.style.display = "block"
    myAtk03.style.left = (x + 10) + "px"
    myAtk03.style.top  = (y + 10) + "px"
    atk03CanHit = false
    atk03TimerStarted = false
  }
}





  // Homing attack
  if (currentAttack === 1 && atkSpawned) {
    let bx = parseInt(myAtk01.style.left)
    let by = parseInt(myAtk01.style.top)

    let dx = x - bx
    let dy = y - by
    let dist = Math.sqrt(dx * dx + dy * dy)

    let speed = 4

    if (dist > 0) {
      bx += (dx / dist) * speed
      by += (dy / dist) * speed
    }

	if (myHitOther('myAtk01', 'myImg01')) {
        playerHit()
    }

    myAtk01.style.left = bx + "px"
    myAtk01.style.top  = by + "px"

    if (dist < 30 || Date.now() - atkStartTime > 5000) {
	resetAttack()
    }
  }

  // atk3 lifetime
 if (currentAttack === 3 && atkSpawned) {

  if (Date.now() - atkStartTime > 3000) {
    atk03CanHit = true
  }

  if (atk03CanHit && myHitOther('myAtk03', 'myImg01')) {
    playerHit()
  }

  if (Date.now() - atkStartTime > 4000) {
resetAttack()
}

  }
}

}

function resetAttack() {
  myAtk01.style.display = "none"
  myAtk03.style.display = "none"
  currentAttack = null
  atkSpawned = false

  isAttacking = false
}

// Attacking
function attack() {
  if (isAttacking) return
  isAttacking = true

  attackBox.style.display = "block"

  if (myDirection === "right") {
    attackBox.style.left = (x + 75) + "px"
    attackBox.style.top  = (y - 20) + "px"
  } else {
    attackBox.style.left = (x - 60) + "px"
    attackBox.style.top  = (y - 20) + "px"
  }

  // Check hit immediately
  if (myHitOther('attackBox', 'myImg02')) {
    enemyHit()
  }

  // Ensure attack always despawns and unlocks
  setTimeout(() => {
    attackBox.style.display = "none"
    isAttacking = false
  }, attackDuration)
}

// When Enemy is hit
function enemyHit() {
	if (myEnemyHp >= 10) {
	document.getElementById('myImg02').style.display = "none"
	console.log ("enemy defeated!")
	document.getElementById('myBody').style.backgroundImage = "url('Title Screen.gif')"
	document.getElementById('myBody').style.backgroundRepeat = "repeat"
	document.getElementById('myBody').style.backgroundSize = "85%"
	bossFight = false
	} else {
	myEnemyHp ++
	}
	}

 //Player hp 
	function playerHit() {
  const now = Date.now()

  // i-frame check
  if (now - lastHitTime < IFRAME_DURATION) return

  lastHitTime = now
  playerHP--

  resetAttack()
 
  myImg01.style.opacity = "0.5"
  setTimeout(() => myImg01.style.opacity = "1", IFRAME_DURATION)


  console.log("Player HP:", playerHP)

  if (playerHP <= 0) {
    document.getElementById('myImg01').style.display = "none"
    document.getElementById('myBody').style.backgroundImage = "url('Death Screen.gif')"
    document.getElementById('myBody').style.backgroundRepeat = "repeat"
    document.getElementById('myBody').style.backgroundSize = "85%"
	bossFight = false
	reset ()
  }
}

function reset() {
  
  isAttacking = false
  myDirection = "right"
  playerHP = 3
  lastHitTime = 0
  myImg01.style.opacity = "1"

  
  bossFight = true
  myEnemyHp = 0
  currentAttack = 0
  atkActive = true
  atkSpawned = false
  atkStartTime = 0


  myAtk01.style.display = "none"
  myAtk03.style.display = "none"


  x = 50
  y = 800
  myImg01.style.left = x + "px"
  myImg01.style.top = y + "px"
  myImg01.style.display = "block"

  document.getElementById('myBody').style.backgroundImage =
    "url('Boss Background.gif')"
  document.getElementById('myBody').style.backgroundRepeat = "repeat"
  document.getElementById('myBody').style.backgroundSize = "25%"

  console.log("reset complete")
}
</script>
